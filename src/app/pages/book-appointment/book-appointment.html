<div class="booking-container">
  <a routerLink="/doctors" class="back-link">← Back to doctors</a>

  @if (appointmentDetails(); as data) {
    <div class="content-grid">
      <div class="summary-card">
        <h2>Booking Summary</h2>
        <div class="doctor-preview">
          <div class="avatar">{{ getInitials(data.doctor.name) }}</div>
          <div>
            <h3>{{ data.doctor.name }}</h3>
            <p class="specialty">{{ data.doctor.specialty }}</p>
          </div>
        </div>
        
        <div class="details-list">
          <div class="detail-item">
            <span class="label">Date</span>
            <span class="value">{{ data.slot.slot_date }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Time</span>
            <span class="value highlight">{{ data.slot.slot_time }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Rating</span>
            <span class="value">★ {{ data.doctor.rating || 'N/A' }}</span>
          </div>
        </div>
      </div>

      <div class="form-card">
        <h2>Patient Details</h2>
        @if (errorMessage()) {
          <div class="form-error-message">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span>{{ errorMessage() }}</span>
          </div>
        }
        <form [formGroup]="bookingForm" (ngSubmit)="onSubmit()">
          <div class="form-group">
            <label>Full Name</label>
            <input 
              type="text" 
              formControlName="patientName" 
              placeholder="Enter your name"
              [class.error]="bookingForm.get('patientName')?.invalid && bookingForm.get('patientName')?.touched"
              (input)="onFieldChange()">
            @if (bookingForm.get('patientName')?.invalid && bookingForm.get('patientName')?.touched) {
              <span class="error-msg">
                @if (bookingForm.get('patientName')?.errors?.['required']) {
                  Full name is required
                } @else if (bookingForm.get('patientName')?.errors?.['minlength']) {
                  Name must be at least 2 characters
                }
              </span>
            }
          </div>

          <div class="form-group">
            <label>Mobile Number</label>
            <input 
              type="tel" 
              formControlName="mobileNumber" 
              placeholder="10-digit number"
              [class.error]="bookingForm.get('mobileNumber')?.invalid && bookingForm.get('mobileNumber')?.touched"
              (input)="onFieldChange()"
              maxlength="10">
            @if (bookingForm.get('mobileNumber')?.invalid && bookingForm.get('mobileNumber')?.touched) {
              <span class="error-msg">
                @if (bookingForm.get('mobileNumber')?.errors?.['required']) {
                  Mobile number is required
                } @else if (bookingForm.get('mobileNumber')?.errors?.['pattern']) {
                  Please enter a valid 10-digit mobile number
                }
              </span>
            }
          </div>

          <div class="form-group">
            <label>Email Address</label>
            <input 
              type="email" 
              formControlName="email" 
              placeholder="email@example.com"
              [class.error]="bookingForm.get('email')?.invalid && bookingForm.get('email')?.touched"
              (input)="onFieldChange()">
            @if (bookingForm.get('email')?.invalid && bookingForm.get('email')?.touched) {
              <span class="error-msg">
                @if (bookingForm.get('email')?.errors?.['required']) {
                  Email address is required
                } @else if (bookingForm.get('email')?.errors?.['email']) {
                  Please enter a valid email address
                }
              </span>
            }
          </div>

          <button type="submit" class="btn-confirm" [disabled]="isSubmitting() || bookingForm.invalid">
            {{ isSubmitting() ? 'Processing...' : 'Confirm Appointment' }}
          </button>
        </form>
      </div>
    </div>
  } @else {
    <div class="loading-state">
      <p>Finding appointment details...</p>
    </div>
  }

  @if (showSuccess()) {
  <div class="success-overlay">
    <div class="success-card">
      <div class="icon-container">
        <div class="check">✓</div>
        <div class="confetti"></div>
      </div>
      
      <h2>Booking Confirmed!</h2>
      
      <div class="confirmation-details">
        <p class="main-msg">Journey Step Completed Successfully.</p>
        
        <div class="email-badge">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
          <span>Confirmation email sent to <strong>{{ bookingForm.get('email')?.value }}</strong></span>
        </div>

        <p class="navigator-note">
          Your <strong>Digital Care Navigator</strong> is now tracking this journey. 
          Expect a reminder 2 hours before your appointment.
        </p>
      </div>

      <div class="auto-redirect">
        Redirecting to dashboard...
      </div>
    </div>
  </div>
}
</div>